<html>
<head>
	<meta charset="utf-8">
	<style>
		body {
			background-color: #000;
			color: #fff;
		}
	</style>
</head>
<body>
	<pre id="output"></pre>
	$ uni <input id="input"> (^L to clear output)

	<script src="wasm_exec.js"></script>
	<script src="term.js"></script>
	<script>
		fetch('main.wasm').then(response => response.arrayBuffer()).then(function(bin) {
			term(window.output, window.input, function(cmd) {
				const go = new Go();
				go.argv = cmd;

				// Write stdout to terminal.
				let outputBuf = '';
				const decoder = new TextDecoder("utf-8");
				global.fs.writeSync = function(fd, buf) {
					outputBuf += decoder.decode(buf);
					const nl = outputBuf.lastIndexOf("\n");
					if (nl != -1) {
						window.output.innerText += outputBuf.substr(0, nl + 1);
						window.scrollTo(0, document.body.scrollHeight);
						outputBuf = outputBuf.substr(nl + 1);
					}
					return buf.length;
				};

				WebAssembly.instantiate(bin, go.importObject).then((result) => {
					go.run(result.instance);
				});
			});
		});
	</script>
</body>
</html>
